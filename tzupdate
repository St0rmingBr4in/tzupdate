#!/usr/bin/env python

"""Automatically determine local time zone based on IP geolocation."""

import argparse
import httplib
import json
import os
import urllib

class MissingZoneInfoFile(Exception):
    """Raised when we can't find a timezone in our local zoneinfo database."""
    pass

class autoTZ():
    """Automatically determine local time zone based on IP geolocation."""
    def __init__(self, localTimeFile="/etc/localtime", zoneInfoDir="/usr/share/zoneinfo"):
        self.localTimeFile = localTimeFile
        self.zoneInfoDir = zoneInfoDir

        self.uris = {
            "geolocate":{
                "host":"api.hostip.info",
                "path":"/get_json.php?position=true"
            },
            "timezone":{
                "host":"api.geonames.org",
                "path":"/timezoneJSON?"
            }
        }
        self.conns = self._connect()

    def _connect(self):
        """Connect to APIs."""
        connections = {}
        for k, v in self.uris.items():
            connections[k] = httplib.HTTPConnection(v["host"])
        return connections

    def locateIP(self):
        """Get geolocation information for our IP."""
        self.conns["geolocate"].request("GET", self.uris["geolocate"]["path"])
        return json.load(self.conns["geolocate"].getresponse())

    def getTimeZoneFromCoords(self, lat, lng, user="tzupdate", **extras):
        """Get the timezone for a latitude/longitude."""
        self.conns["timezone"].request("GET", self.uris["timezone"]["path"] +
            urllib.urlencode({
                "lat":lat,
                "lng":lng,
                "username":user # Please be respectful and use your own username
                                # if you know you are going to make lots of
                                # API requests.
            })
        )
        ret = json.loads(self.conns["timezone"].getresponse().read())
        return ret["timezoneId"]

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("-d", "--dry-run", action="store_true", help="Don't update the localtime symlink")
    parser.add_argument("-u", "--geonames-username", default="tzupdate", help="Override default GeoNames username")
    parser.add_argument("-v", "--verbose", action="store_true", help="Print what we are doing")
    args = parser.parse_args()

    a = autoTZ()
    tz = a.getTimeZoneFromCoords(**a.locateIP())
    tzPath = os.path.join(a.zoneInfoDir, tz)
    if not os.path.isfile(tzPath):
        raise MissingZoneInfoFile(tz)
    if os.path.exists(a.localTimeFile):
        os.unlink(a.localTimeFile)
    os.symlink(tzPath, a.localTimeFile)
    print "Set timezone: %s" % tz
