#!/usr/bin/env python

"""Automatically determine local time zone based on IP geolocation."""

import argparse
import httplib
import json
import os
import sys
import urllib

class MissingZoneInfoFile(Exception):
    """Raised when we can't find a timezone in our local zoneinfo database."""
    pass

class autoTZ():
    """Automatically determine local time zone based on IP geolocation."""
    def __init__(self, localTimeFile="/etc/localtime", zoneInfoDir="/usr/share/zoneinfo"):
        self.localTimeFile = localTimeFile
        self.zoneInfoDir = zoneInfoDir

        self.uris = {
            "geolocate":{
                "host":"api.ipinfodb.com",
                "path":"/v3/ip-city/?"
            },
            "timezone":{
                "host":"api.geonames.org",
                "path":"/timezoneJSON?"
            }
        }
        self.conns = self._connect()

    def _connect(self):
        """Connect to APIs."""
        connections = {}
        for k, v in self.uris.items():
            connections[k] = httplib.HTTPConnection(v["host"])
        return connections

    def locateIP(self, key="c253fddcfa96b60155aa66fb51b20cbadbcfa2020b2d27a89d4554ac2799b935"):
        """Get geolocation information for our IP."""
        self.conns["geolocate"].request("GET", self.uris["geolocate"]["path"] +
            urllib.urlencode({
                "key":key,
                "format":"json"
            })
        )
        return json.load(self.conns["geolocate"].getresponse())

    def getTimeZoneFromCoords(self, latitude, longitude, user="tzupdate", **extras):
        """Get the timezone for a latitude/longitude."""
        self.conns["timezone"].request("GET", self.uris["timezone"]["path"] +
            urllib.urlencode({
                "lat":latitude,
                "lng":longitude,
                "username":user # Please be respectful and use your own username
                                # if you know you are going to make lots of
                                # API requests.
            })
        )
        ret = json.loads(self.conns["timezone"].getresponse().read())
        return ret["timezoneId"]

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("-d", "--dry-run", action="store_true", help="Don't update the localtime symlink")
    parser.add_argument("-i", "--ipinfodb-api-key", default="c253fddcfa96b60155aa66fb51b20cbadbcfa2020b2d27a89d4554ac2799b935", help="Override default API key for IPInfoDB")
    parser.add_argument("-u", "--geonames-username", default="tzupdate", help="Override default GeoNames username")
    parser.add_argument("-v", "--verbose", action="store_true", help="Print what we are doing")
    args = parser.parse_args()

    if args.verbose:
        def vprint(*args):
            print " ".join(args)
    else:
        vprint = lambda *args: None

    a = autoTZ()

    vprint("Locating IP")
    ipGeo = a.locateIP(key=args.ipinfodb_api_key)
    vprint("Located at %(latitude)s, %(longitude)s" % ipGeo)

    vprint("Getting timezone for coordinates")
    tz = a.getTimeZoneFromCoords(**ipGeo)
    vprint("Timezone is %s" % tz)

    tzPath = os.path.join(a.zoneInfoDir, tz)
    if not os.path.isfile(tzPath):
        raise MissingZoneInfoFile(tz)
    if os.path.exists(a.localTimeFile):
        vprint("localtime file %s already exists, unlinking" % a.localTimeFile)
        os.unlink(a.localTimeFile)
    vprint("Symlinking %s to %s" % (a.localTimeFile, tzPath))
    os.symlink(tzPath, a.localTimeFile)
    print "Set timezone: %s" % tz
